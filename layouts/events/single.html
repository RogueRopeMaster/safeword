{{ define "title" }}
  {{ .Title }} Â· {{ .Site.Title }}
{{ end }}

{{ define "content" }}
  {{ $rawBody := replaceRE `(?s)^\s*!\[[^\]]*\]\([^)]+\)\s*` "" .RawContent }}
  {{ $cleanBody := strings.TrimSpace $rawBody }}
  {{ $fetlifeURL := partial "events/fetlife-url.html" . }}
  {{ $ticketsURL := partial "events/tickets-url.html" . }}
  {{ $ticketCode := partial "events/ticket-code.html" . }}
  {{ $eventDate := partial "events/date-time.html" . }}
  {{ $today := now.Format "2006-01-02" }}
  {{ $isUpcoming := ge ($eventDate | time.Format "2006-01-02") $today }}
  {{ $showTicketWidget := and $isUpcoming (ne (strings.TrimSpace $ticketsURL) "") (ne (strings.TrimSpace $ticketCode) "") }}
  {{ $currentPage := . }}
  {{ $pages := where .Site.RegularPages "Section" "events" }}
  {{ $pages = sort $pages "Params.event_date" "desc" }}
  {{ $curIndex := 0 }}

  {{ range $index, $page := $pages }}
    {{ if eq $page.Permalink $currentPage.Permalink }}
      {{ $curIndex = $index }}
    {{ end }}
  {{ end }}

  <section class="container page event-page">
    <article class="event-detail">
      <header class="event-detail-header">
        <div class="event-detail-cover">
          {{ with .Params.image }}
            {{ $imageAlt := $.Params.image_alt | default (printf "Poster for %s" $.Title) }}
            <img src="{{ . }}" alt="{{ $imageAlt }}" class="event-detail-image">
          {{ else }}
            <div class="event-detail-fallback" aria-hidden="true">
              <i class="fa-solid fa-masks-theater"></i>
            </div>
          {{ end }}
          <div class="event-detail-overlay">
            <p class="event-detail-kicker">{{ i18n "events_detail_kicker" | default "Event Night" }}</p>
            <h1 class="title">{{ .Title }}</h1>
            <p class="event-detail-date">
              <i class="fa-regular fa-calendar"></i>
              {{ $eventDate | time.Format (.Site.Params.dateFormat | default "January 2, 2006") }}
            </p>
          </div>
        </div>
        <a class="event-back-link" href="{{ .CurrentSection.RelPermalink }}">
          <i class="fa-solid fa-arrow-left"></i>
          {{ i18n "events_back_to_list" | default "Back to all events" }}
        </a>
        {{ if ne $fetlifeURL "" }}
          <a class="event-fetlife-link" href="{{ $fetlifeURL }}" target="_blank" rel="noopener noreferrer">
            <i class="fa-solid fa-up-right-from-square"></i>
            {{ i18n "events_open_fetlife" | default "Open on FetLife" }}
          </a>
        {{ end }}
        {{ if and $isUpcoming (ne $ticketsURL "") }}
          <a class="event-fetlife-link" href="{{ $ticketsURL }}" target="_blank" rel="noopener noreferrer">
            <i class="fa-solid fa-ticket"></i>
            {{ i18n "events_open_tickets" | default "Open ticket shop" }}
          </a>
        {{ end }}
      </header>

      <div class="event-detail-body">
        {{ if ne $cleanBody "" }}
          {{ $rawBody | markdownify }}
        {{ else }}
          {{ .Content }}
        {{ end }}
      </div>

      {{ if $showTicketWidget }}
        <section class="event-ticket-box">
          <div class="event-ticket-box-head">
            <h2>{{ i18n "home_tickets_heading" | default "Tickets" }}</h2>
            <a class="event-fetlife-link" href="{{ $ticketsURL }}" target="_blank" rel="noopener noreferrer">
              <i class="fa-solid fa-ticket"></i>
              {{ i18n "events_open_tickets" | default "Open ticket shop" }}
            </a>
          </div>
          <div class="event-ticket-widget-shell">
            <pretix-widget event="{{ $ticketsURL }}" single-item-select="button"></pretix-widget>
            <noscript>
              <div class="pretix-widget">
                <div class="pretix-widget-info-message">
                  {{ i18n "home_tickets_noscript_prefix" | default "JavaScript is disabled in your browser. To access our ticket shop without JavaScript, please" }}
                  <a target="_blank" rel="noopener noreferrer" href="{{ $ticketsURL }}">
                    {{ i18n "home_tickets_noscript_link" | default "click here" }}
                  </a>.
                </div>
              </div>
            </noscript>
          </div>
        </section>
      {{ end }}

      <div class="event-navigation">
        {{ if gt $curIndex 0 }}
          {{ $prevIndex := sub $curIndex 1 }}
          {{ $prevPage := index $pages $prevIndex }}
          <a href="{{ $prevPage.RelPermalink }}" class="event-nav-button event-nav-previous">
            <span class="event-nav-direction">
              <i class="fa-solid fa-arrow-left"></i>
              {{ i18n "events_previous" | default "Previous event" }}
            </span>
            <span class="event-nav-title">{{ $prevPage.Title }}</span>
          </a>
        {{ else }}
          <span class="event-nav-spacer" aria-hidden="true"></span>
        {{ end }}

        {{ if lt $curIndex (sub (len $pages) 1) }}
          {{ $nextIndex := add $curIndex 1 }}
          {{ $nextPage := index $pages $nextIndex }}
          <a href="{{ $nextPage.RelPermalink }}" class="event-nav-button event-nav-next">
            <span class="event-nav-direction">
              {{ i18n "events_next" | default "Next event" }}
              <i class="fa-solid fa-arrow-right"></i>
            </span>
            <span class="event-nav-title">{{ $nextPage.Title }}</span>
          </a>
        {{ else }}
          <span class="event-nav-spacer" aria-hidden="true"></span>
        {{ end }}
      </div>
    </article>
  </section>
{{ end }}
